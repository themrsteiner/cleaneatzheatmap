<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gyms + Clean Eatz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    /* Right-side boxes: hug content */
    .layer-toggles { position:absolute; z-index:1000; top:14px; right:14px; background:#fff; border:1px solid #ccc; border-radius:10px; padding:8px 10px; font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; box-shadow:0 2px 8px rgba(0,0,0,.08); display:inline-block; width:max-content; }
    .layer-toggles label { display:flex; align-items:center; gap:6px; margin:6px 0; white-space:nowrap; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .dot-red { background:#e11d48; }
    .dot-yellow { background:#facc15; border:1px solid #000; box-sizing:border-box; border-radius:50%; }
    .swatch-rainbow { width:14px; height:10px; border-radius:2px; border:1px solid #999; display:inline-block; background:linear-gradient(90deg,#ff004c,#ff7a00,#ffd400,#27c93f,#1e90ff,#7a5cff,#b832ff); }

    /* Subtract panel sits below layers and hugs content */
    .subtract-panel { position:absolute; z-index:1000; top:120px; right:14px; background:#fff; border:1px solid #ccc; border-radius:10px; padding:10px 12px; font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; box-shadow:0 2px 8px rgba(0,0,0,.08); display:inline-block; width:max-content; }
    .subtract-panel .title { font-weight:600; margin-bottom:6px; }
    .subtract-panel label { display:flex; align-items:center; gap:6px; margin:6px 0; white-space:nowrap; }

    /* Bottom-right slider + readout */
    .right-bottom-controls { position:absolute; z-index:1000; right:14px; bottom:14px; display:grid; grid-template-rows:auto auto; gap:10px; pointer-events:none; }
    .box { background:#fff; border:1px solid #ccc; border-radius:10px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; pointer-events:all; }
    .box.center { text-align:center; }
    .label-title { font-weight:600; }
    .readout { margin-top:4px; font-size:13px; }
    .slider-box { display:flex; align-items:center; justify-content:center; padding:10px; width:50px; }
    .vslider { writing-mode:bt-lr; -webkit-appearance:slider-vertical; width:10px; height:180px; }
    input[type="range"].vslider::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:#111; }
    input[type="range"].vslider::-moz-range-thumb { width:18px; height:18px; border-radius:50%; background:#111; border:none; }
  </style>
</head>
<body>
<div id="map"></div>

<!-- Layers (visibility only) -->
<div class="layer-toggles">
  <strong>Layers</strong>
  <label><input id="toggle-gyms" type="checkbox" checked /> <span class="swatch-rainbow"></span> Gyms</label>
  <label><input id="toggle-ce"   type="checkbox" checked /> <span class="dot dot-red"></span> Clean Eatz</label>
  <label><input id="toggle-competitors" type="checkbox" /> <span class="dot dot-yellow"></span> Competitors</label>
</div>

<!-- Subtractive controls (math only) -->
<div class="subtract-panel">
  <div class="title">Subtract from heat</div>
  <label><input id="sub-ce" type="checkbox" checked /> Clean Eatz</label>
  <label><input id="sub-comps" type="checkbox" /> Competitors</label>
</div>

<!-- Bottom-right slider + readout -->
<div class="right-bottom-controls">
  <div class="box center">
    <div class="label-title">Subtract Radius</div>
    <div class="readout"><span id="miles-readout">25</span> mi</div>
  </div>
  <div class="box slider-box">
    <input id="dist-slider" class="vslider" type="range" min="0" max="100" step="1" value="25" />
  </div>
</div>

<script>
const DATASETS = {
  gyms: 'data/gyms.csv',
  cleanEatz: 'data/clean_eatz.csv',
  sweetgreen: 'data/comp_sweetgreen.csv',
  justsalad: 'data/comp_just_salad.csv',
  bolay: 'data/comp_bolay.csv',
  vitality: 'data/comp_vitality_bowls.csv',
  protein: 'data/comp_proteinhouse.csv'
};
const COMP_KEYS = ['sweetgreen','justsalad','bolay','vitality','protein'];
const HEAT_POINT_WEIGHT = 0.9;
const HEAT_OPTIONS = { radius: 14, blur: 16, maxZoom: 11, minOpacity: 0.28 };

const map = L.map('map', { preferCanvas:true }).setView([39.5, -98.35], 4);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 18 }).addTo(map);

// Competitor points pane (always above heat + CE logos)
map.createPane('competitorPane');
map.getPane('competitorPane').style.zIndex = 660;

function pickLat(row){ return row['@lat'] ?? row['lat'] ?? row['latitude'] ?? row['y'] ?? null; }
function pickLon(row){ return row['@lon'] ?? row['lon'] ?? row['lng'] ?? row['longitude'] ?? row['x'] ?? null; }
const R_EARTH_MI = 3958.7613; const toRad=d=>d*Math.PI/180;
function haversineMi(aLat,aLon,bLat,bLon){ const dLat=toRad(bLat-aLat), dLon=toRad(bLon-aLon); const s1=Math.sin(dLat/2)**2; const s2=Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLon/2)**2; return 2*R_EARTH_MI*Math.asin(Math.sqrt(s1+s2)); }

let gymsRaw = [], gymsHeat = null;
let cleanEatz = [];
const ceLayer = L.layerGroup().addTo(map);
const CE_ICON_SIZE = [22,22];
const ceIcon = L.icon({ iconUrl:'data/logo_cek.png', iconSize:CE_ICON_SIZE, iconAnchor:[CE_ICON_SIZE[0]/2, CE_ICON_SIZE[1]/2] });

const compMasterLayer = L.layerGroup();
const compSublayers = {}; // key -> LayerGroup
const subtractCache = {};                 // key -> [{lat,lon,name?}]
const activeSubtractors = new Set(['cleanEatz']); // CE subtracts by default

async function loadCsv(url){ const res=await fetch(url,{cache:'force-cache'}); if(!res.ok) throw new Error('HTTP '+res.status+' for '+url); const text=await res.text(); const p=Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true}); return p.data; }

function drawCleanEatz(){ ceLayer.clearLayers(); for(const r of cleanEatz){ const m=L.marker([r.lat,r.lon],{icon:ceIcon,title:r.name||'Clean Eatz'}); const nm=r.name||'Clean Eatz'; m.bindPopup('<strong>'+nm+'</strong><br>'+r.lat.toFixed(5)+', '+r.lon.toFixed(5)); ceLayer.addLayer(m);} }

function gatherSubtractors(){ const pts=[]; activeSubtractors.forEach(key=>{ const arr=subtractCache[key]; if(!arr) return; for(const p of arr){ pts.push(p);} }); return pts; }

function updateHeatForDistance(miles){
  const subs = gatherSubtractors();
  let filtered = gymsRaw;
  if(subs.length && miles>0){ filtered=[]; for(const g of gymsRaw){ let covered=false; for(const s of subs){ if(haversineMi(g.lat,g.lon,s.lat,s.lon) <= miles){ covered=true; break; } } if(!covered) filtered.push(g); } }
  const pts = filtered.map(p => [p.lat, p.lon, HEAT_POINT_WEIGHT]);
  if(gymsHeat) map.removeLayer(gymsHeat);
  gymsHeat = L.heatLayer(pts, HEAT_OPTIONS);
  if(document.getElementById('toggle-gyms').checked){ gymsHeat.addTo(map); }
}

function buildCompetitorSublayer(key){
  const arr = subtractCache[key] || [];
  const lg = L.layerGroup();
  for(const r of arr){
    const m = L.circleMarker([r.lat,r.lon], {
      pane: 'competitorPane', radius: 4,
      color: '#000', weight: 2,
      fillColor: '#facc15', fillOpacity: 0.95
    });
    const nm = r.name || key; m.bindPopup('<strong>'+nm+'</strong><br>'+r.lat.toFixed(5)+', '+r.lon.toFixed(5));
    lg.addLayer(m);
  }
  compSublayers[key] = lg;
}

async function ensureLoaded(key){ if(subtractCache[key]) return; const url=DATASETS[key]; if(!url) return; const rows=await loadCsv(url); subtractCache[key]=rows.map(r=>{ const lat=Number(pickLat(r)), lon=Number(pickLon(r)); if(!Number.isFinite(lat)||!Number.isFinite(lon)) return null; return {lat,lon,name:r.name||r.Name||null}; }).filter(Boolean); if(['sweetgreen','justsalad','bolay','vitality','protein'].includes(key)){ buildCompetitorSublayer(key);} }

async function setCompetitorsSubtract(on){ if(on){ for(const key of ['sweetgreen','justsalad','bolay','vitality','protein']){ activeSubtractors.add(key); await ensureLoaded(key);} } else { for(const key of ['sweetgreen','justsalad','bolay','vitality','protein']){ activeSubtractors.delete(key);} } updateHeatForDistance(Number(document.getElementById('dist-slider').value)); }
async function setCleanEatzSubtract(on){ if(on){ activeSubtractors.add('cleanEatz'); if(!subtractCache['cleanEatz']) await ensureLoaded('cleanEatz'); } else { activeSubtractors.delete('cleanEatz'); } updateHeatForDistance(Number(document.getElementById('dist-slider').value)); }

// Slider UI
const slider = document.getElementById('dist-slider'); const readout=document.getElementById('miles-readout'); let debounce=null;
slider.addEventListener('input', ()=>{ readout.textContent=slider.value; if(debounce) cancelAnimationFrame(debounce); debounce=requestAnimationFrame(()=> updateHeatForDistance(Number(slider.value))); });

// View toggles (visibility only)
document.getElementById('toggle-gyms').addEventListener('change', (e)=>{ if(!gymsHeat) return; if(e.target.checked) gymsHeat.addTo(map); else map.removeLayer(gymsHeat); });
document.getElementById('toggle-ce').addEventListener('change', (e)=>{ if(e.target.checked) ceLayer.addTo(map); else map.removeLayer(ceLayer); });
document.getElementById('toggle-competitors').addEventListener('change', async (e)=>{ if(e.target.checked){ compMasterLayer.addTo(map); for(const key of ['sweetgreen','justsalad','bolay','vitality','protein']){ if(!subtractCache[key]) await ensureLoaded(key); if(!compSublayers[key]) buildCompetitorSublayer(key); compSublayers[key].addTo(compMasterLayer);} } else { compMasterLayer.clearLayers(); map.removeLayer(compMasterLayer);} });

(async function init(){
  const gymsRows = await loadCsv(DATASETS.gyms); gymsRaw = gymsRows.map(r=>{ const lat=Number(pickLat(r)), lon=Number(pickLon(r)); return (Number.isFinite(lat)&&Number.isFinite(lon))?{lat,lon}:null; }).filter(Boolean);
  const ceRows = await loadCsv(DATASETS.cleanEatz); cleanEatz = ceRows.map(r=>{ const lat=Number(pickLat(r)), lon=Number(pickLon(r)); if(!Number.isFinite(lat)||!Number.isFinite(lon)) return null; return {lat,lon,name:r.name||r.Name||null}; }).filter(Boolean); subtractCache['cleanEatz'] = cleanEatz.slice();
  drawCleanEatz(); document.getElementById('miles-readout').textContent = slider.value; updateHeatForDistance(Number(slider.value));
  document.getElementById('sub-ce').addEventListener('change', async (e)=>{ await setCleanEatzSubtract(e.target.checked); });
  document.getElementById('sub-comps').addEventListener('change', async (e)=>{ await setCompetitorsSubtract(e.target.checked); });
})();
</script>
</body>
</html>
